#!/usr/bin/env perl
use warnings;
use strict;
use Getopt::Std;
use Siebel::Lbconfig qw(recover_info get_daemon);
use File::HomeDir 1.00;
use File::Spec;

# VERSION

$Getopt::Std::STANDARD_HELP_VERSION = 2;

sub HELP_MESSAGE {
    my $option = shift;

    if ( ( defined($option) ) and ( ref($option) eq '' ) ) {
        print "'-$option' parameter cannot be null\n";
    }

    print <<BLOCK;

lbconfig - version $main::VERSION

This program will connect to a Siebel server, verify all AOM components eligible for load balancing and generate a corresponding lbconfig.txt file.

The parameters available are:

    -h: prints this help message and exits
    -p <PORT>: the Siebel Connection Broker port. This parameter is optional, the default value for it is 2321.
    -c: optional parameter to the complete path to the configuration file (defaults to .lbconfig.cfg in the user home directory).
        See the Pod of Siebel::Lbconfig for details on the configuration file.

Beware that environment variables required to connect to a Siebel Enterprise are expected to be already in place.

BLOCK

    exit(0);

}

our %opts;
getopts( 'p:c:h', \%opts );
HELP_MESSAGE() if ( exists( $opts{h} ) );

#foreach my $option (qw(n o)) {
#    HELP_MESSAGE($option) unless ( defined( $opts{$option} ) );
#}

my $cfg_file;
my $default = File::Spec->catfile( File::HomeDir->my_home(), '.lbconfig.cfg' );

if ( exists( $opts{c} ) ) {

    if ( -r $opts{c} ) {
        $cfg_file = $opts{c};
    }
    else {
        die "file $opts{c} does not exist or is not readable";
    }

}
elsif ( -e $default ) {
    $cfg_file = $default;
}
else {
    die
"No default configuration file available, create it or specify one with -c option";
}

my $port;
if ( exists( $opts{p} ) ) {
    $port = $opts{p};
}
else {
    $port = 2321;
}

my ( $daemon, $stash ) = get_daemon($cfg_file);
$daemon->run;
my $data_ref = recover_info( $stash, $port );

use Data::Dumper;
print Dumper($data_ref);
